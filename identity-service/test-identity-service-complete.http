###############################################################################
# IDENTITY SERVICE - COMPLETE API TESTING
# Base URL: http://localhost:8081
# Description: Comprehensive test cases including success and error scenarios
###############################################################################

### Variables
@baseUrl = http://localhost:8081/api/v1/identity
@accessToken = {{login_response.response.body.accessToken}}
@userId = {{login_response.response.body.userId}}

###############################################################################
# 1. AUTHENTICATION ENDPOINTS
###############################################################################

### 1.1. Register - Success (STUDENT)
# @name register_student_success
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstname": "Nguyễn Văn",
  "lastname": "An",
  "email": "student.test@gmail.com",
  "role": "STUDENT",
  "password": "Test123456@_",
  "confirmPassword": "Test123456@_"
}

###
# Expected Output:
# HTTP/1.1 201 Created
# (No body - Success indicated by 201 status)

### 1.2. Register - Success (TEACHER)
# @name register_teacher_success
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstname": "Trần Thị",
  "lastname": "Bích",
  "email": "teacher.test@gmail.com",
  "role": "TEACHER",
  "password": "Test123456@_",
  "confirmPassword": "Test123456@_"
}

###
# Expected Output:
# HTTP/1.1 201 Created

### 1.3. Register - Error: Email Already Exists
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstname": "Duplicate",
  "lastname": "User",
  "email": "student.test@gmail.com",
  "role": "STUDENT",
  "password": "Test123456@_",
  "confirmPassword": "Test123456@_"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "code": "EMAIL_ALREADY_EXISTS",
#   "message": "Email already exists"
# }

### 1.4. Register - Error: Password Mismatch
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstname": "Test",
  "lastname": "User",
  "email": "mismatch@gmail.com",
  "role": "STUDENT",
  "password": "Test123456@_",
  "confirmPassword": "DifferentPassword123@_"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "code": "PASSWORD_MISMATCH",
#   "message": "Password mismatch confirm password"
# }

### 1.5. Register - Error: Invalid Email Format
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstname": "Test",
  "lastname": "User",
  "email": "invalid-email",
  "role": "STUDENT",
  "password": "Test123456@_",
  "confirmPassword": "Test123456@_"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "email": "VALIDATION.REGISTRATION.EMAIL.FORMAT"
# }

### 1.6. Register - Error: Firstname Too Short
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstname": "A",
  "lastname": "Nguyen",
  "email": "short.name@gmail.com",
  "role": "STUDENT",
  "password": "Test123456@_",
  "confirmPassword": "Test123456@_"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "firstname": "VALIDATION.REGISTRATION.FIRSTNAME.SIZE"
# }

### 1.7. Register - Error: Weak Password
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstname": "Test",
  "lastname": "User",
  "email": "weak.pass@gmail.com",
  "role": "STUDENT",
  "password": "weak",
  "confirmPassword": "weak"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "password": "VALIDATION.REGISTRATION.PASSWORD.SIZE"
# }

### 1.8. Register - Error: Missing Required Fields
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstname": "",
  "lastname": "",
  "email": "",
  "password": ""
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "firstname": "VALIDATION.REGISTRATION.FIRSTNAME.NOT_BLANK",
#   "lastname": "VALIDATION.REGISTRATION.LASTNAME.NOT_BLANK",
#   "email": "VALIDATION.REGISTRATION.EMAIL.NOT_BLANK",
#   "role": "VALIDATION.REGISTRATION.ROLE.NOT_NULL",
#   "password": "VALIDATION.REGISTRATION.PASSWORD.NOT_BLANK"
# }

###############################################################################

### 1.9. Login - Success
# @name login_response
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "student.test@gmail.com",
  "password": "Test123456@_"
}

###
# Expected Output:
# HTTP/1.1 200 OK
# Set-Cookie: refreshToken=<token>; Path=/; HttpOnly; SameSite=Lax
# {
#   "accessToken": "eyJhbGciOiJSUzI1NiJ9...",
#   "userId": "uuid-string",
#   "email": "student.test@gmail.com",
#   "role": "STUDENT"
# }

### 1.10. Login - Error: Wrong Password
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "student.test@gmail.com",
  "password": "WrongPassword123@_"
}

###
# Expected Output:
# HTTP/1.1 401 Unauthorized
# {
#   "code": "BAD_CREDENTIALS",
#   "message": "Email and / or password is incorrect"
# }

### 1.11. Login - Error: User Not Found
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "nonexistent@gmail.com",
  "password": "Test123456@_"
}

###
# Expected Output:
# HTTP/1.1 401 Unauthorized
# {
#   "code": "BAD_CREDENTIALS",
#   "message": "Email and / or password is incorrect"
# }

### 1.12. Login - Error: Invalid Email Format
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "invalid-email",
  "password": "Test123456@_"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "email": "VALIDATION.AUTHENTICATION.EMAIL.FORMAT"
# }

### 1.13. Login - Error: Empty Credentials
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "",
  "password": ""
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "email": "VALIDATION.AUTHENTICATION.EMAIL.NOT_BLANK",
#   "password": "VALIDATION.AUTHENTICATION.PASSWORD.NOT_BLANK"
# }

### 1.14. Login - Error: Deactivated Account
# (First create and deactivate an account, then try to login)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "deactivated@gmail.com",
  "password": "Test123456@_"
}

###
# Expected Output:
# HTTP/1.1 401 Unauthorized
# {
#   "code": "ERROR_USER_DISABLE",
#   "message": "User is disable"
# }

###############################################################################

### 1.15. Refresh Token - Success
# @name refresh_response
POST {{baseUrl}}/auth/refresh
Cookie: refreshToken=<paste-refresh-token-from-login-cookie>

###
# Expected Output:
# HTTP/1.1 200 OK
# Set-Cookie: refreshToken=<new-token>; Path=/; HttpOnly; SameSite=Lax
# {
#   "accessToken": "new-jwt-token...",
#   "userId": "uuid",
#   "email": "student.test@gmail.com",
#   "role": "STUDENT"
# }

### 1.16. Refresh Token - Error: Missing Cookie
POST {{baseUrl}}/auth/refresh

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "code": "INVALID_TOKEN",
#   "message": "Invalid token"
# }

### 1.17. Refresh Token - Error: Invalid Token
POST {{baseUrl}}/auth/refresh
Cookie: refreshToken=invalid.token.here

###
# Expected Output:
# HTTP/1.1 401 Unauthorized
# {
#   "code": "INVALID_TOKEN",
#   "message": "Invalid token"
# }

### 1.18. Refresh Token - Error: Expired Token
POST {{baseUrl}}/auth/refresh
Cookie: refreshToken=<expired-token>

###
# Expected Output:
# HTTP/1.1 401 Unauthorized
# {
#   "code": "REFRESH_TOKEN_EXPIRED",
#   "message": "Refresh token has expired"
# }

###############################################################################

### 1.19. Logout - Success
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 204 No Content
# Set-Cookie: refreshToken=; Max-Age=0; Path=/

### 1.20. Logout - Without Authentication (Should still succeed)
POST {{baseUrl}}/auth/logout

###
# Expected Output:
# HTTP/1.1 204 No Content

###############################################################################
# 2. USER PROFILE ENDPOINTS
###############################################################################

### 2.1. Get Own Profile - Success
GET {{baseUrl}}/me/
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 200 OK
# {
#   "id": "uuid",
#   "firstname": "Nguyễn Văn",
#   "lastname": "An",
#   "email": "student.test@gmail.com",
#   "role": "STUDENT",
#   "isActive": true,
#   "createdAt": "2026-01-17T10:30:00",
#   "updatedAt": "2026-01-17T10:30:00"
# }

### 2.2. Get Own Profile - Error: No Token
GET {{baseUrl}}/me/

###
# Expected Output:
# HTTP/1.1 401 Unauthorized
# {
#   "code": "INVALID_TOKEN",
#   "message": "Invalid token"
# }

### 2.3. Get Own Profile - Error: Invalid Token
GET {{baseUrl}}/me/
Authorization: Bearer invalid.token.here

###
# Expected Output:
# HTTP/1.1 401 Unauthorized
# {
#   "code": "INVALID_TOKEN",
#   "message": "Invalid token"
# }

### 2.4. Get Own Profile - Error: Expired Token
GET {{baseUrl}}/me/
Authorization: Bearer <expired-token>

###
# Expected Output:
# HTTP/1.1 401 Unauthorized
# {
#   "code": "TOKEN_EXPIRED",
#   "message": "Token has expired"
# }

###############################################################################

### 2.5. Get User Profile by ID - Success
GET {{baseUrl}}/me/{{userId}}
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 200 OK
# {
#   "id": "uuid",
#   "firstname": "Nguyễn Văn",
#   "lastname": "An",
#   "email": "student.test@gmail.com",
#   "role": "STUDENT",
#   "isActive": true,
#   "createdAt": "2026-01-17T10:30:00",
#   "updatedAt": "2026-01-17T10:30:00"
# }

### 2.6. Get User Profile by ID - Error: User Not Found
GET {{baseUrl}}/me/non-existent-uuid
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 404 Not Found
# {
#   "code": "USER_NOTFOUND",
#   "message": "User not found with id non-existent-uuid"
# }

### 2.7. Get User Profile by ID - Error: Invalid UUID Format
GET {{baseUrl}}/me/invalid-id-format
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 404 Not Found or 400 Bad Request
# {
#   "code": "USER_NOTFOUND",
#   "message": "User not found with id invalid-id-format"
# }

###############################################################################

### 2.8. Update Profile - Success
PATCH {{baseUrl}}/me/
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "firstname": "Nguyễn Văn Updated",
  "lastname": "An",
  "role": "STUDENT"
}

###
# Expected Output:
# HTTP/1.1 204 No Content

### 2.9. Update Profile - Error: Firstname Too Short
PATCH {{baseUrl}}/me/
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "firstname": "N",
  "lastname": "An",
  "role": "STUDENT"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "firstname": "VALIDATION.UPDATE_INFORMATION.FIRSTNAME.SIZE"
# }

### 2.10. Update Profile - Error: Lastname Too Long
PATCH {{baseUrl}}/me/
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "firstname": "Nguyễn Văn",
  "lastname": "AnVeryLongLastName",
  "role": "STUDENT"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "lastname": "VALIDATION.UPDATE_INFORMATION.LASTNAME.SIZE"
# }

### 2.11. Update Profile - Error: Missing Required Fields
PATCH {{baseUrl}}/me/
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "firstname": "",
  "lastname": ""
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "firstname": "VALIDATION.UPDATE_INFORMATION.FIRSTNAME.NOT_BLANK",
#   "lastname": "VALIDATION.UPDATE_INFORMATION.LASTNAME.NOT_BLANK",
#   "role": "VALIDATION.UPDATE_INFORMATION.ROLE.NOT_NULL"
# }

### 2.12. Update Profile - Error: No Authentication
PATCH {{baseUrl}}/me/
Content-Type: application/json

{
  "firstname": "Test",
  "lastname": "User",
  "role": "STUDENT"
}

###
# Expected Output:
# HTTP/1.1 401 Unauthorized

###############################################################################

### 2.13. Change Password - Success
POST {{baseUrl}}/me/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "Test123456@_",
  "newPassword": "NewPassword123@_",
  "confirmPassword": "NewPassword123@_"
}

###
# Expected Output:
# HTTP/1.1 204 No Content

### 2.14. Change Password - Error: Wrong Current Password
POST {{baseUrl}}/me/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "WrongPassword123@_",
  "newPassword": "NewPassword123@_",
  "confirmPassword": "NewPassword123@_"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "code": "INVALID_CURRENT_PASSWORD",
#   "message": "Mismatching current password"
# }

### 2.15. Change Password - Error: Password Mismatch
POST {{baseUrl}}/me/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "Test123456@_",
  "newPassword": "NewPassword123@_",
  "confirmPassword": "DifferentPassword123@_"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "code": "CHANGE_PASSWORD_MISMATCH",
#   "message": "New password mismatch confirm password"
# }

### 2.16. Change Password - Error: Weak New Password
POST {{baseUrl}}/me/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "Test123456@_",
  "newPassword": "weak",
  "confirmPassword": "weak"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "newPassword": "VALIDATION.CHANGE_PASSWORD.NEW_PASSWORD.SIZE"
# }

### 2.17. Change Password - Error: Password Without Special Character
POST {{baseUrl}}/me/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "Test123456@_",
  "newPassword": "NewPassword123",
  "confirmPassword": "NewPassword123"
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "newPassword": "VALIDATION.CHANGE_PASSWORD.NEW_PASSWORD.WEAK"
# }

### 2.18. Change Password - Error: Missing Fields
POST {{baseUrl}}/me/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "",
  "newPassword": "",
  "confirmPassword": ""
}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "currentPassword": "VALIDATION.CHANGE_PASSWORD.CURRENT_PASSWORD.NOT_BLANK",
#   "newPassword": "VALIDATION.CHANGE_PASSWORD.NEW_PASSWORD.NOT_BLANK",
#   "confirmPassword": "VALIDATION.CHANGE_PASSWORD.CONFIRM_PASSWORD.NOT_BLANK"
# }

### 2.19. Change Password - Error: No Authentication
POST {{baseUrl}}/me/password
Content-Type: application/json

{
  "currentPassword": "Test123456@_",
  "newPassword": "NewPassword123@_",
  "confirmPassword": "NewPassword123@_"
}

###
# Expected Output:
# HTTP/1.1 401 Unauthorized

###############################################################################

### 2.20. Deactivate Account - Success
POST {{baseUrl}}/me/deactivate
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 204 No Content

### 2.21. Deactivate Account - Error: Already Deactivated
POST {{baseUrl}}/me/deactivate
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "code": "ACCOUNT_ALREADY_DEACTIVATED",
#   "message": "Account with id <uuid> is already deactivated"
# }

### 2.22. Deactivate Account - Error: No Authentication
POST {{baseUrl}}/me/deactivate

###
# Expected Output:
# HTTP/1.1 401 Unauthorized

###############################################################################

### 2.23. Reactivate Account - Success (Login with deactivated account first)
# @name login_deactivated
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "student.test@gmail.com",
  "password": "NewPassword123@_"
}

###

### 2.24. Reactivate Account - Success
POST {{baseUrl}}/me/reactivate
Authorization: Bearer {{login_deactivated.response.body.accessToken}}

###
# Expected Output:
# HTTP/1.1 204 No Content

### 2.25. Reactivate Account - Error: Already Activated
POST {{baseUrl}}/me/reactivate
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 400 Bad Request
# {
#   "code": "ACCOUNT_ALREADY_ACTIVATED",
#   "message": "Account with id <uuid> is already activated"
# }

### 2.26. Reactivate Account - Error: No Authentication
POST {{baseUrl}}/me/reactivate

###
# Expected Output:
# HTTP/1.1 401 Unauthorized

###############################################################################

### 2.27. Delete Account - Success
DELETE {{baseUrl}}/me/delete
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 204 No Content

### 2.28. Delete Account - Error: User Already Deleted
DELETE {{baseUrl}}/me/delete
Authorization: Bearer {{accessToken}}

###
# Expected Output:
# HTTP/1.1 404 Not Found
# {
#   "code": "USER_NOTFOUND",
#   "message": "User not found with id <uuid>"
# }

### 2.29. Delete Account - Error: No Authentication
DELETE {{baseUrl}}/me/delete

###
# Expected Output:
# HTTP/1.1 401 Unauthorized

###############################################################################
# 3. HEALTH CHECK ENDPOINT
###############################################################################

### 3.1. Health Check - Success
GET {{baseUrl}}/health

###
# Expected Output:
# HTTP/1.1 200 OK
# {
#   "status": "UP",
#   "service": "identity-service",
#   "timestamp": "2026-01-17T10:30:00"
# }

###############################################################################
# TEST EXECUTION GUIDE
###############################################################################

# RECOMMENDED TEST SEQUENCE:
# 
# Phase 1 - Setup (Create Test Users):
#   1. Run test 1.1 (Register Student)
#   2. Run test 1.2 (Register Teacher)
#
# Phase 2 - Authentication Tests:
#   3. Run test 1.9 (Login Success) - Save tokens
#   4. Run tests 1.3-1.8, 1.10-1.14 (Registration errors)
#   5. Run test 1.15 (Refresh Token)
#   6. Run tests 1.16-1.18 (Refresh errors)
#
# Phase 3 - Profile Management Tests:
#   7. Run test 2.1 (Get Own Profile)
#   8. Run tests 2.2-2.4 (Get profile errors)
#   9. Run test 2.5 (Get profile by ID)
#   10. Run tests 2.6-2.7 (Get by ID errors)
#   11. Run test 2.8 (Update Profile)
#   12. Run tests 2.9-2.12 (Update errors)
#
# Phase 4 - Password Management Tests:
#   13. Run test 2.13 (Change Password)
#   14. Run tests 2.14-2.19 (Password errors)
#   15. Login again with new password
#
# Phase 5 - Account State Tests:
#   16. Run test 2.20 (Deactivate)
#   17. Run test 2.21 (Deactivate error)
#   18. Try login (should fail with ERROR_USER_DISABLE)
#   19. Run test 2.24 (Reactivate)
#   20. Run test 2.25 (Reactivate error)
#
# Phase 6 - Cleanup:
#   21. Run test 2.27 (Delete Account)
#   22. Run test 2.28 (Delete error)
#   23. Run test 1.19 (Logout)
#
# NOTES:
# - Replace {{accessToken}} with actual token from login response
# - Replace {{userId}} with actual user ID from login response
# - Some tests require manual token manipulation (expired tokens)
# - Refresh token is stored in HttpOnly cookie, copy from browser dev tools if needed
# - Database should be reset between full test runs for consistency
